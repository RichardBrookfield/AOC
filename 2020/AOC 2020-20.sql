USE [Richard];

SET NOCOUNT ON;

DROP TABLE IF EXISTS [#Tile];
DROP TABLE IF EXISTS [#TileContent];
DROP TABLE IF EXISTS [#TileEdge];
DROP TABLE IF EXISTS [#EdgePattern];
DROP TABLE IF EXISTS [#Layout];

DROP PROCEDURE IF EXISTS [#ExtractEdgePattern];
DROP PROCEDURE IF EXISTS [#InsertPattern];
DROP PROCEDURE IF EXISTS [#PlaceTile];
GO

CREATE TABLE [#Tile]
(
	[ID]			int				NOT NULL	IDENTITY(1,1)
	,[tileID]		int				NOT NULL
);

CREATE TABLE [#TileContent]
(
	[tileID]		int				NOT NULL
	,[row]			int				NOT NULL
	,[content]		char(10)		NOT NULL
);

CREATE TABLE [#TileEdge]
(
	[tileID]		int				NOT NULL
	,[reversed]		bit				NOT NULL
	,[edge]			int				NOT NULL
	,[patternID]	int				NOT NULL
	,[reverseID]	int				NULL

	,INDEX [idx_all]		NONCLUSTERED ([tileID], [reversed], [edge], [patternID])
);

CREATE TABLE [#EdgePattern]
(
	[patternID]		int				NOT NULL	IDENTITY(1,1)
	,[content]		char(10)		NOT NULL

	,INDEX [idx_all]	NONCLUSTERED	([patternID])
);

CREATE TABLE [#Layout]
(
	[row]			int				NOT NULL
	,[column]		int				NOT NULL
	,[tileID]		int				NOT NULL
	,[orientation]	int				NOT NULL
	,[reversed]		bit				NOT NULL
);

GO

CREATE PROCEDURE [#InsertPattern]
	@content		char(10)
	,@patternID		int			OUTPUT
AS
BEGIN
	SELECT	@patternID = NULL;

	SELECT	@patternID = [patternID]
	FROM	[#EdgePattern]
	WHERE	[content] = @content;

	IF @patternID IS NULL
	BEGIN
		INSERT INTO [#EdgePattern] ([content])
		VALUES (@content);

		SELECT	@patternID = SCOPE_IDENTITY();
	END
END
GO

CREATE PROCEDURE [#ExtractEdgePattern]
	@tileID		int
AS
BEGIN
	--Edges	0=N / 1=E / 2=S / 3=W
	DECLARE	@content	varchar(10)
			,@ch		char(1)
			,@patternID	int;

	SELECT	@content = [content]
	FROM	[#TileContent]
	WHERE	[tileID]	= @tileID
	AND		[row]		= 1;

	EXEC [dbo].[#InsertPattern] @content=@content, @patternID=@patternID OUTPUT;
	INSERT INTO [#TileEdge] ([tileID], [reversed], [edge], [patternID])
	VALUES (@tileID, 0, 0, @patternID);

	SELECT	@content = REVERSE(@content);

	EXEC [dbo].[#InsertPattern] @content=@content, @patternID=@patternID OUTPUT;
	INSERT INTO [#TileEdge] ([tileID], [reversed], [edge], [patternID])
	VALUES (@tileID, 1, 0, @patternID);

	SELECT	@content = [content]
	FROM	[#TileContent]
	WHERE	[tileID]	= @tileID
	AND		[row]		= 10;

	EXEC [dbo].[#InsertPattern] @content=@content, @patternID=@patternID OUTPUT;
	INSERT INTO [#TileEdge] ([tileID], [reversed], [edge], [patternID])
	VALUES (@tileID, 1, 2, @patternID);

	SELECT	@content = REVERSE(@content);

	EXEC [dbo].[#InsertPattern] @content=@content, @patternID=@patternID OUTPUT;
	INSERT INTO [#TileEdge] ([tileID], [reversed], [edge], [patternID])
	VALUES (@tileID, 0, 2, @patternID);

	SELECT	@content	= '';

	SELECT		@content += SUBSTRING([content], 10, 1)
	FROM		[#TileContent]
	WHERE		[tileID] = @tileID
	ORDER BY	[row];

	EXEC [dbo].[#InsertPattern] @content=@content, @patternID=@patternID OUTPUT;
	INSERT INTO [#TileEdge] ([tileID], [reversed], [edge], [patternID])
	VALUES (@tileID, 0, 1, @patternID);

	SELECT	@content = REVERSE(@content);

	EXEC [dbo].[#InsertPattern] @content=@content, @patternID=@patternID OUTPUT;
	INSERT INTO [#TileEdge] ([tileID], [reversed], [edge], [patternID])
	VALUES (@tileID, 1, 3, @patternID);

	SELECT	@content = '';

	SELECT		@content += SUBSTRING([content], 1, 1)
	FROM		[#TileContent]
	WHERE		[tileID] = @tileID
	ORDER BY	[row] DESC;

	EXEC [dbo].[#InsertPattern] @content=@content, @patternID=@patternID OUTPUT;
	INSERT INTO [#TileEdge] ([tileID], [reversed], [edge], [patternID])
	VALUES (@tileID, 0, 3, @patternID);

	SELECT	@content = REVERSE(@content);

	EXEC [dbo].[#InsertPattern] @content=@content, @patternID=@patternID OUTPUT;
	INSERT INTO [#TileEdge] ([tileID], [reversed], [edge], [patternID])
	VALUES (@tileID, 1, 1, @patternID);
END
GO

CREATE PROCEDURE [#PlaceTile]
	@tileDepth		int
	,@tiles			int
	,@tileRows		int
	,@tileColumns	int	
AS
BEGIN
	DECLARE	@id					int = 1
			,@state				int
			,@orientation		int
			,@reversed			bit
			,@tileID			int
			,@patternID			int
			,@otherTileID		int
			,@otherOrientation	int
			,@otherPattern		int
			,@otherReversed		bit
			,@fits				bit
			,@newDepth			int	= @tileDepth + 1
			,@tileRow			int	= @tileDepth / @tileColumns + 1
			,@tileColumn		int = @tileDepth % @tileColumns + 1;

	PRINT CAST(@tileDepth AS varchar(10));

	IF @tileDepth >= @tiles
	BEGIN
		SELECT * FROM [#layout];
		PRINT 'Done: '
		RETURN 0;
	END

	WHILE @id <= @tiles
	BEGIN
		SELECT	@tileID = [tileID]
		FROM	[#Tile]
		WHERE	[id] = @id;

		IF NOT EXISTS (SELECT 1 FROM #Layout WHERE [tileID] = @tileID)
		BEGIN
			SELECT	@state = 0;
			WHILE @state < 8
			BEGIN
				SELECT	@orientation	= @state % 4
						,@reversed		= CASE WHEN @state > 3 THEN 1 ELSE 0 END
						,@fits			= 1;

				IF @tileColumn > 1
				BEGIN
					SELECT	@otherTileID		= [tileID]
							,@otherOrientation	= [orientation]
							,@otherReversed		= [reversed]
					FROM	[#Layout]
					WHERE	[row]		= @tileRow
					AND		[column]	= @tileColumn-1;

					SELECT	@patternID = [patternID]
					FROM	[#TileEdge] [TE]
					WHERE	[TE].[tileID]	= @tileID
					AND		[TE].[edge]		= (3 + @orientation) % 4
					AND		[TE].[reversed]	= @reversed;

					SELECT	@otherPattern = [reverseID]
					FROM	[#TileEdge] [TE]
					WHERE	[TE].[tileID]	= @otherTileID
					AND		[TE].[edge]		= (1 + @otherOrientation) % 4
					AND		[TE].[reversed]	= @otherReversed;

					IF @patternID <> @otherPattern
					BEGIN
						SELECT	@fits = 0;
					END
				END

				IF @fits = 1 AND @tileRow > 1
				BEGIN
					SELECT	@otherTileID		= [tileID]
							,@otherOrientation	= [orientation]
							,@otherReversed		= [reversed]
					FROM	[#Layout]
					WHERE	[row]		= @tileRow-1
					AND		[column]	= @tileColumn;

					SELECT	@patternID = [patternID]
					FROM	[#TileEdge] [TE]
					WHERE	[TE].[tileID]	= @tileID
					AND		[TE].[edge]		= (0 + @orientation) % 4
					AND		[TE].[reversed]	= @reversed;

					SELECT	@otherPattern = [reverseID]
					FROM	[#TileEdge] [TE]
					WHERE	[TE].[tileID]	= @otherTileID
					AND		[TE].[edge]		= (2 + @otherOrientation) % 4
					AND		[TE].[reversed]	= @otherReversed;

					IF @patternID <> @otherPattern
					BEGIN
						SELECT	@fits = 0;
					END
				END

				IF @fits = 1
				BEGIN
					INSERT INTO [#Layout] ([row], [column], [tileID], [orientation], [reversed])
					VALUES (@tileRow, @tileColumn, @tileID, @orientation, @reversed);

					EXEC [dbo].[#PlaceTile]
							@tileDepth		= @newDepth
							,@tiles			= @tiles
							,@tileRows		= @tileRows
							,@tileColumns	= @tileColumns;

					DELETE FROM [#Layout]
					WHERE	[row]		= @tileRow
					AND		[column]	= @tileColumn;
				END

				SELECT @state += 1;
			END
		END

		SELECT	@id += 1;
	END
END
GO

-- Test
DECLARE @inputT	varchar(MAX) = '
Tile 2311:
..##.#..#.
##..#.....
#...##..#.
####.#...#
##.##.###.
##...#.###
.#.#.#..##
..#....#..
###...#.#.
..###..###

Tile 1951:
#.##...##.
#.####...#
.....#..##
#...######
.##.#....#
.###.#####
###.##.##.
.###....#.
..#.#..#.#
#...##.#..

Tile 1171:
####...##.
#..##.#..#
##.#..#.#.
.###.####.
..###.####
.##....##.
.#...####.
#.##.####.
####..#...
.....##...

Tile 1427:
###.##.#..
.#..#.##..
.#.##.#..#
#.#.#.##.#
....#...##
...##..##.
...#.#####
.#.####.#.
..#..###.#
..##.#..#.

Tile 1489:
##.#.#....
..##...#..
.##..##...
..#...#...
#####...#.
#..#.#.#.#
...#.#.#..
##.#...##.
..##.##.##
###.##.#..

Tile 2473:
#....####.
#..#.##...
#.##..#...
######.#.#
.#...#.#.#
.#########
.###.#..#.
########.#
##...##.#.
..###.#.#.

Tile 2971:
..#.#....#
#...###...
#.#.###...
##.##..#..
.#####..##
.#..####.#
#..#.#..#.
..####.###
..#.#.###.
...#.#.#.#

Tile 2729:
...#.#.#.#
####.#....
..#.#.....
....#..#.#
.##..##.#.
.#.####...
####.#.#..
##.####...
##..#.##..
#.##...##.

Tile 3079:
#.#.#####.
.#..######
..#.......
######....
####.#..#.
.#...#.##.
#.#####.##
..#.###...
..#.......
..#.###...
';

-- Puzzle
DECLARE @input	varchar(MAX) = '
Tile 1787:
#..#.#...#
....####..
#.........
...#..#..#
.##....##.
#....#....
...#....##
.......#.#
.......#.#
.##.####.#

Tile 2687:
...#####..
#..##.....
..#.......
##..#..##.
##........
..........
#....#...#
#......#.#
.......#.#
########..

Tile 3359:
##.....#.#
....#.#..#
......##.#
#.##...#..
##...##..#
#....##..#
...#.....#
#.....#...
...#...#.#
##.#..##.#

Tile 1907:
.##..#..##
..#.#.#..#
#.........
..##....#.
...#....#.
#..#.....#
......#..#
##.....#..
#.#.....#.
...#.....#

Tile 1231:
##........
##..#..#.#
.#..#....#
.....##...
....#.#.#.
#.#.#....#
....##.#..
#.#.#....#
....#....#
.###..####

Tile 3301:
.##.#....#
..##.....#
#.........
####...#..
..#.......
#.#....#..
#..##.#.##
#........#
.......#..
.....#....

Tile 3137:
..#...##.#
.#.....#.#
#...#..###
....#..#..
#.........
#.........
#.........
.#..#.#..#
#........#
...#.####.

Tile 3917:
.#....##..
##..#..#..
#........#
#...#.#..#
.#........
.#........
#..#...##.
.#.#...#..
...#...#..
...##....#

Tile 1901:
#.########
..#......#
###.#..#..
.#...##..#
.##.#...#.
.....#...#
#.#..###..
#..#.##.#.
...#.....#
...##.###.

Tile 2399:
####.#.#..
##...#..##
##......##
#.......##
........##
....##..#.
........##
.........#
#.#...####
#.#....#..

Tile 3793:
..##.#.###
.#..#....#
...#......
..#...#...
....##....
..##..#..#
..........
#.........
.#..#....#
##.#.###.#

Tile 1303:
..#..#.##.
...#......
..........
...#...#..
.........#
###......#
.....#..#.
#.........
#...#....#
#.##.#.###

Tile 1997:
###.##..#.
...#.#....
....#....#
##...##...
#...#...#.
##......#.
#.#...##.#
....#....#
#......#.#
##.#.#...#

Tile 3083:
.##.#####.
#.........
........#.
...#.#....
#....#....
#........#
##.....#..
...#..#...
.....#....
###.##..##

Tile 3853:
.#...####.
..........
......#...
#.........
#.#.....#.
#........#
#..#.#....
#..#.....#
.....##..#
####.#####

Tile 2917:
..##.#..##
#.#......#
....##.#..
#..###.#..
.#..#...#.
..#..#..##
..........
#.#..#.#.#
.....#..#.
#####...#.

Tile 1831:
.###.##.##
.#.#.....#
....#....#
#.####....
...##.....
#......#.#
.##.......
..#.....#.
#...##....
..#..###.#

Tile 3371:
..####.###
##....#.#.
......##.#
#.........
........##
.#..#....#
.##......#
#.#....#..
##.....#.#
....#.....

Tile 1433:
.#..#.####
..#..#..#.
...#..#...
#.....#...
#....#...#
.......##.
.........#
#....###..
..#..##.#.
#..#######

Tile 3347:
#....##..#
.#....###.
#.#.#.....
..........
........##
#.......##
.....#...#
#.........
..#......#
..#..###..

Tile 1933:
.##...#.##
....#.....
#..##.#...
......##.#
#..##...##
#........#
#....##...
....#.....
#.......##
#.##.#.#..

Tile 2971:
#.##.#.#.#
.##.......
##.##.#.##
#.........
#.....#..#
.....#..#.
##.......#
#...##.#.#
#........#
#.##....##

Tile 3011:
.#..#.###.
.........#
....#.....
.#.......#
..#......#
........##
#....###..
#......#.#
#.....#..#
.##...##.#

Tile 2069:
..#..#..##
#.........
#....##...
#........#
#.##.....#
.........#
.....##...
......#.##
..#.......
#.##...##.

Tile 1511:
.#.##.##.#
#..##.#...
....#....#
#.#..#....
####.....#
.###..#...
..#...#..#
##..#..##.
#..##...##
##..#.#.##

Tile 1637:
..#..#.###
.......#..
#........#
..#...#...
..........
#........#
#...#..#.#
.##.#.#..#
...#...#.#
#.####.###

Tile 1609:
#..####.##
#....#...#
.....##...
#....#...#
....#...##
#........#
.....#....
....#.....
#.##.#....
#..###.##.

Tile 2749:
##...#.##.
......##..
.........#
##.....#.#
#.##...##.
#.#..#..##
..#...##.#
#...#....#
...#....##
..########

Tile 2141:
....###.#.
....#.##..
.....#..#.
#.#.##...#
........#.
#..#....##
#....#...#
.#.......#
#.....#...
##..#.#..#

Tile 3769:
#..##.##..
##..#..#.#
..##....##
........#.
#..#..#...
##.#..##.#
.#...#...#
###......#
..........
####.###..

Tile 2083:
.###...#..
.#.#......
#...#..#.#
#.........
##.......#
.......#.#
#..#....##
#.......##
#.#.......
.##.#.##.#

Tile 2579:
.###..####
..#..#.#.#
.#........
..........
....##....
#...##...#
##.......#
..........
..........
#..#.##.#.

Tile 3229:
#####..#.#
#.........
#.....#..#
##.....#..
#....#...#
.##...#..#
.....#...#
...##..###
.#.#.....#
...###...#

Tile 2663:
.#.#..####
#......#.#
#.........
##..##.#..
..##...##.
#.#......#
##........
#.#.#...#.
##.....#.#
###...##..

Tile 1709:
.####....#
.#...##...
#.#.#.....
.....#....
..........
..#...#.##
##........
..........
#...##....
#.#.######

Tile 2153:
#####....#
....###..#
.........#
........#.
...#...#..
###..#...#
..##...#..
#.......##
#.....###.
##.###...#

Tile 2803:
#..##..#..
####.#....
#....#.#..
.#.......#
#.#..#..##
#.#...#...
##...##...
.#......##
##.#......
###...####

Tile 1297:
..###.#..#
#...#...#.
....#....#
#...##...#
..#..#...#
#..##.#..#
.#..#.....
#......#..
.#..#..##.
.#.##..###

Tile 3491:
....####..
#...#...##
#...#....#
#...#.#...
##.#.##...
.#........
..##..#.#.
#.....#...
##........
.#.#.#....

Tile 1549:
#..####.#.
#........#
.#........
...#....##
..........
#...##...#
#........#
#...#...##
..#.....#.
#..##..#.#

Tile 3527:
#.###...##
...#...#.#
#..##.#..#
.#.##..#..
........#.
#......###
...#...#..
#.....#.##
#.##......
########.#

Tile 3517:
.#.#..#...
#....#...#
#...#.#...
..#.......
#....#....
#..#.....#
##....#...
#..#.....#
.......#..
#.#..#.##.

Tile 2503:
##....##.#
.....#...#
#.........
#..#.....#
#...#..#..
...#......
#...#...#.
.#.#.....#
#.#.##...#
.#...##.##

Tile 2081:
###......#
#.##.#....
#......##.
.#..#....#
.....#...#
#....#.#.#
.##.......
..........
.......#.#
#.##.#.#.#

Tile 1301:
##.#.#.##.
#.#....#..
.#...#....
#....#..#.
.......#.#
.#.......#
.#.......#
.#.##..#..
.#.....##.
.##.#....#

Tile 3191:
####.#.#..
#.........
.#.....##.
.#...##..#
....#.###.
##.......#
#........#
.#.....#.#
......#..#
#.###.#...

Tile 2539:
.#....#.##
#........#
...##....#
#.........
#....#....
..........
.......#..
....#..#.#
#....##..#
....###.#.

Tile 2819:
#..#####..
....#....#
......#...
###.......
....#....#
#..###...#
#.#..##..#
..#..#...#
###....#..
..#.##.##.

Tile 3989:
###.#..#.#
.....#.##.
.......#.#
.....#.#..
....##..#.
#.......##
#.##...#.#
.....#.###
#.#.#..###
.##..##.#.

Tile 1249:
......#...
#.#......#
....#....#
#.#...####
.........#
........#.
#.........
.......##.
......#..#
.#.##.#.##

Tile 3221:
..##.#.###
#........#
#......#..
##.....#..
....#....#
....#....#
#..#......
..#.....#.
.........#
.#####.##.

Tile 2801:
.##..#.#.#
#.#..#..##
.#....##..
.......#..
#...#.....
#....#....
#.........
.##.#.#.##
.....#...#
.###.#..##

Tile 2137:
#.##.#.##.
#......#..
...##.#..#
.#..#..##.
#.#####.#.
#...#.....
.....#...#
#...###..#
.#.#...#.#
..###.##.#

Tile 3673:
.###.#####
......#..#
.###.#....
..........
.#..#....#
....#.....
.#...#....
#..#....#.
##.#.....#
.#.###.##.

Tile 1747:
####.##.#.
#........#
#.....#..#
.....#...#
....#.#..#
..........
.#.#......
##........
........##
###..###.#

Tile 3121:
#....#..#.
##....#.#.
#..#.....#
.#.......#
..#...#.#.
#....#.##.
.....#...#
#....##...
#.#.......
###.####..

Tile 2521:
#.##..##..
#....#..##
#..#......
#..###....
#.......#.
...#..#..#
#...#....#
....##..##
#.........
.##.#.#.##

Tile 1583:
...#.#####
#..#...#..
##........
.#.......#
......###.
......#..#
#...#....#
.....#.#..
#.........
##.#..###.

Tile 3541:
..##..#..#
..##..##..
#.#..##...
...#.#..##
....#...#.
#.#..#....
.........#
...#.#...#
##..##.#.#
#.#..#..##

Tile 1187:
.......#.#
#.........
.....#..#.
...#..#...
.#.......#
.#.#.#...#
#.#.....#.
#......##.
.#.......#
.##..#####

Tile 3257:
##.#...#.#
#.#.#.....
##....#.##
.....#.#.#
#.....####
#..#...#..
#....#....
.#.......#
.....#..##
####.....#

Tile 2969:
###.##.##.
.....#.#..
##.#....##
#.....#...
...#.#...#
...#..##..
......#..#
..#.......
.#.....#..
..##.#.#.#

Tile 3433:
#.#.#..#..
###.#.#...
.#......##
#.##...#.#
.......#.#
.#.......#
..#......#
.#.....#.#
###.#...##
.##..#.#..

Tile 1427:
.#.#####.#
.#...#.###
..##.###..
..........
..#.......
#....#.#..
.........#
.....##..#
###......#
#.##.#..#.

Tile 1559:
#..#.#.##.
..##.....#
#.##......
#.#.#.####
..........
..##......
#....#....
.###..#.#.
#...#.....
.#.###.##.

Tile 1777:
#....#..#.
#.........
........##
###....#.#
#......#..
....#....#
#.#...#...
##...#....
.........#
##.###.##.

Tile 3169:
.#...#####
.....#....
.##..#.##.
..#.#.#..#
...##....#
#..#......
#...#....#
..#..###.#
.....###..
#..##.###.

Tile 2459:
##.##..#..
.........#
...#..#.#.
#..##..#.#
#.....#..#
..........
#.......#.
..##.....#
..........
.#.......#

Tile 1019:
...#.#.###
#........#
.........#
#.....#..#
.#........
...#.#...#
#.....#..#
.......#..
#.......#.
####.##.#.

Tile 3929:
#.##..###.
#..#....##
..##...#.#
#.#...##.#
#..#...#..
.......#..
.........#
##.#....##
..#....#..
#.###.....

Tile 1447:
####.####.
#..#.#...#
.#....#..#
......#.##
#.........
.#....#.##
....#.....
.......#..
#..#.##..#
#...#.####

Tile 1627:
##.#######
#.#....#..
##.......#
#....#.#..
#.........
#..#...#..
....#.....
.....#....
#.....#.##
##.##.#.#.

Tile 3719:
#.....#...
.#...#..##
..........
###.##.#..
.........#
#.#......#
...#.....#
......##.#
#..#......
#....#.###

Tile 2267:
###..##.##
.....#...#
#.....#...
.....#.#.#
#......###
........##
.......#..
#.#...#...
#.....#.#.
..##...#.#

Tile 1291:
..###...#.
#..#...#..
....#...#.
.##.##.#..
#...#.#.##
.........#
#.....#...
......#.##
.#...#...#
#...#.#...

Tile 3701:
.###.##.#.
......###.
...#......
..#...#.#.
#.##......
.#.#....#.
.###.#..##
.###......
#..##....#
##..#..###

Tile 1607:
...#.##.#.
.....#.#..
...#.##..#
#.........
###......#
.#........
..#.....##
..#.#.#...
.#.##.....
.#.###...#

Tile 3877:
.##.#...##
#...##.#..
#.......##
##.....#..
....#...#.
......#.##
.##..##...
#...#.....
.........#
.##.#..#.#

Tile 1471:
#....##.#.
#...#....#
..#......#
##.###...#
.#.####...
#...#....#
...#....#.
..........
###....#..
.##.#...#.

Tile 2017:
.####.###.
##....#..#
....#.#.##
#...#...##
#.........
#........#
..#.....#.
#........#
..........
...####.#.

Tile 1987:
......#.#.
..#....#..
#.......##
#...#.....
.......#.#
#.#...#...
.#..#.....
.....#.###
..###..#.#
##....#.#.

Tile 1453:
###.###..#
...#......
.....#...#
..#.....##
#........#
.........#
##...#....
.#.......#
..#.#.##..
....#.#.##

Tile 2027:
..#.#..#.#
..#.......
..........
..##.#....
......#...
#...#...##
....#...#.
.....#....
#...#.#.##
#.#####..#

Tile 2411:
##...###..
..#.......
#.#......#
#.#.#...#.
.#.......#
#........#
..#...#..#
#.........
#........#
#..##.#.##

Tile 2939:
....#..#.#
.#.##.#...
.....#..#.
....#...#.
......##.#
...#.##..#
##..##...#
...#.#...#
..#...#..#
...##.####

Tile 1439:
.######.##
..#...#...
.#.#.#..##
#.....#...
.......#.#
#..#.#...#
.....#....
#....#...#
#.##......
...##.....

Tile 3739:
...#...###
....##.#.#
####....##
###.....##
#.........
#.......#.
##........
#.#.......
..##.#....
#####.....

Tile 2957:
###.#.###.
#......#.#
##.......#
...##....#
......#..#
#.#...#...
.....#...#
.......#.#
...#.....#
...#....##

Tile 1861:
##.##....#
.......#..
#........#
...#.....#
#..#.....#
#....#...#
....#....#
#.#.......
....#....#
..###..#..

Tile 3313:
####......
.###.....#
.#.......#
#.......#.
#.##......
###.....##
..#.#.#...
..###....#
###......#
####.#....

Tile 1429:
####....#.
#........#
....#.#...
.......#..
.#...###..
.........#
#........#
#.#......#
#......#.#
##..#..##.

Tile 2707:
.#.#.#....
#........#
.##....#..
....#.#.##
..........
##........
##....#..#
#......#.#
...#..##.#
###..#..##

Tile 2131:
.##.###..#
#...#.....
#.#.##..#.
#.##..#...
#.....####
#..###...#
#####...##
.##.#....#
#....####.
...#######

Tile 3329:
..##.###..
#####....#
..#.#.....
#.........
##...#....
.....#....
#.#...#...
#.########
#...#..#.#
.##.##.#..

Tile 1103:
##.##.###.
#..#...#..
#........#
#........#
....#....#
..#..##..#
..#.#...##
#...##.#..
#.#.##....
.###.##..#

Tile 1201:
#.##.##.##
......#...
..#....#..
..#..###..
...#......
..........
..#...#..#
..#.#.##..
#........#
...#...##.

Tile 2063:
.##..#.##.
.#..##.###
.###...##.
#.#..#..##
#......#.#
#.........
..###.....
........##
.........#
####..##..

Tile 1327:
.#..#.###.
##.......#
.#........
.#.#......
.##.#.#...
.##...#..#
.......#..
#..#.#...#
#.#......#
######..#.

Tile 3779:
...##..##.
#....##..#
..#......#
..#.##....
......##.#
..#.......
.#........
#.#.##....
.##.......
#.###.....

Tile 3061:
....#.###.
#.........
......##.#
#.......##
##....#...
#..#..#...
...#.....#
#.##.....#
#........#
#....#...#

Tile 3323:
#.##.#.#..
...#...#.#
.......#..
#....#....
#......###
........##
#...#.....
#...#.....
#....#...#
####.#...#

Tile 1031:
#..#.#.##.
##...#..##
...#.....#
.....#..##
###.#....#
..#.#....#
..##.#...#
.#...#.#.#
.#........
#.#...#...

Tile 2039:
#.#.###..#
.#.#......
#...##...#
#..#..#...
.#......##
....#....#
#...#.#...
##..##....
#..#.##..#
.#.#...#.#

Tile 1123:
####.###..
#.###..#..
.#...#.#.#
.........#
.....#...#
..##...#.#
...#..#..#
#...##.#.#
..........
#.####.###

Tile 1483:
###.#.####
#.....#.#.
##........
.....#....
...#.....#
......#...
#.........
..#...#..#
#.#.......
...#.#.###

Tile 2053:
..##.#.#..
.....#...#
#..#.....#
##...#...#
.....###..
..........
#...#.....
##.#..#..#
#...##.#.#
..##.#..##

Tile 2879:
...#...###
.....#..#.
#..#......
#.....#...
##...#....
......#...
.#.#......
##...#...#
#..#..#..#
.##...####

Tile 3343:
..#.##...#
#....#..#.
.....#..##
#..#.....#
#...#.....
#.........
#.##....#.
..........
....#.....
.....###..

Tile 3709:
.#..####..
....#.#...
....####..
#...####..
..##..##.#
#....##...
..##......
......#...
#...##.###
.#..#...##

Tile 2531:
..####....
##......#.
.#.......#
#....#....
........##
......#...
##.#.#....
#.........
.##....#..
#..#####.#

Tile 2251:
...#....##
..........
##.......#
#..###...#
#.#..#.###
...##.....
###......#
.##.#.....
.......#.#
####.##.##

Tile 1753:
.#.##...#.
#........#
.#........
#.......#.
...#.#....
......#..#
.#......#.
..........
#..##..#.#
##.##...#.

Tile 2477:
#####.#.##
.......#..
##........
.........#
..........
.........#
##.##....#
#...#.#..#
#......#.#
#.#.#.#...

Tile 1823:
###.#.####
#.#..#..#.
..........
....##....
#.........
#.........
##......##
#........#
..........
##..######

Tile 1801:
###...####
..........
.....##...
.#.#.....#
....#..#..
#.........
#.......#.
#.....#..#
.....#...#
#.##.....#

Tile 2689:
...##....#
..#.......
.#....##.#
...#......
.#.#....##
#.#......#
....####..
..........
....#...##
#.#.#.#...

Tile 1951:
#...##....
#.....#...
.....#...#
.#.#..####
#.#.###..#
#...#..#..
......##..
##........
..#.#....#
.##..#....

Tile 2441:
.##.....#.
......#..#
..#.#.....
#......###
#..#.....#
...#..#.##
..........
......#..#
#..#..##..
###.#.#..#

Tile 1109:
#.#.####..
..#......#
#.....#..#
.#.......#
...#......
..........
#.#....#.#
##.#...#..
#...#....#
##..##.###

Tile 3023:
#..##..#.#
.###.#.###
#....##.##
....#....#
..#.......
#.#.#..#.#
#...#...#.
#...#...##
#......#..
....#.####

Tile 1721:
#...#.##.#
#.........
###..#..#.
..###....#
......##.#
#...#.....
#...#...##
...#.###..
..........
..###.#...

Tile 2887:
..#..#.#.#
.#.....##.
#........#
#.....#..#
.#.....#..
##.....##.
#..#......
.....#...#
#......#..
..###.....

Tile 2659:
#..#.#..#.
#.....#...
....#..#..
#.......#.
.....#..##
........#.
....#....#
#..##.....
..##.#..#.
##.#.##.#.

Tile 2557:
#..#..##..
#.....#...
#....#...#
#...#.....
.#.#......
#......#..
...#...#.#
.......##.
#........#
..#..#.###

Tile 3697:
..##.#...#
#.#.....##
....#....#
.#........
......#...
#......#..
.#.......#
..........
#........#
##.#....##

Tile 3407:
##...###..
#...#.....
#....##...
#........#
#...#.#...
....#..#.#
#...#....#
#........#
#..#.#..##
#..###...#

Tile 2857:
#.###....#
###...###.
.#...#.###
#.#.....##
#.##...##.
#...#..#..
#...###..#
#.#....#..
#..#...#.#
#.#..##.##

Tile 2551:
.#.##.#.#.
#........#
.....#.#..
.#....#...
......#.##
#.......#.
#.#......#
..#.#....#
.#.#...#..
..#.#....#

Tile 1867:
#######...
#.....#.##
#.#...#.#.
#...#.#.##
.....##...
#.#.....##
#.#...#...
....#...#.
#.###....#
#...##..##

Tile 3041:
#.###..#..
..#.......
#...#....#
#....#..##
#......#..
.###..##..
##.##...#.
#..#....##
#........#
##....#.##

Tile 2671:
##..##....
.....#...#
....##....
...#...#..
#...#....#
.......###
.......#.#
.#..#....#
#.....##..
###..##.##

Tile 2543:
..#.#...#.
...#..#...
#.#....##.
...####..#
#.........
##.#....##
##........
#....#....
....#.....
#...##....

Tile 1063:
.#.#.....#
##..#....#
#.##....##
..........
.......#..
#........#
.#......#.
###...#..#
#........#
###.#.#..#

Tile 3539:
.#..###...
..#.....##
.#.##...##
#......#.#
#.#....#..
.#.#.....#
#.##...#..
#.###..###
#.#.#.#.##
.#..######

Tile 2843:
##.....###
#.......##
.........#
.##..##..#
..#.......
#........#
........##
...#.#.#..
.#........
#..##.#.##

Tile 1663:
###.#.#.#.
#.#...#.##
#...#....#
...##.....
.....#...#
#.......#.
#..##.....
...#.#....
..........
..#.#.##..

Tile 1999:
..#.#.#.#.
..........
.......#..
#..#.#....
#.#....#.#
#...#.....
#..##..#..
#...##..##
.#.#....##
.#.....###

Tile 3463:
..##..##.#
#.....#..#
#...##.#..
...##...##
.........#
#.#..#..#.
#....#...#
#........#
#.........
...##...#.

Tile 3823:
#....##..#
..#.##..#.
#..##....#
..........
.........#
......#...
#.#......#
......##.#
..#.......
..##.##.#.

Tile 2777:
.###...###
.........#
##.#...#..
#..#......
#.###.....
.....#..#.
#...#.....
......#...
..##......
...#...##.

Tile 2347:
#...#..#.#
#.#.#.#.##
#....#####
.#...###.#
..##.##.##
.........#
#.........
.....##...
....#.#...
#..#######

Tile 2897:
##.###.##.
.....#..#.
#....##..#
.#..#.#.#.
.#..#....#
#.#.......
##..#....#
......#...
#.#..#....
..#..##...

Tile 2423:
#####.##..
...#......
#.....##.#
.#..##...#
##.###..##
...#...#..
#........#
.........#
#####..###
###.##..#.

Tile 2797:
...#.##.##
#.....#..#
.........#
..###..#.#
....#....#
#.#.......
.#.#....#.
..........
#...#...#.
.#.####..#
';

DECLARE @inputRaw table
(
	[id]			int				NOT NULL		IDENTITY(1,1)
	,[value]		varchar(100)	NOT NULL
);

INSERT INTO @inputRaw
SELECT	[value]
FROM	STRING_SPLIT(REPLACE(@inputT, CHAR(13), ''), CHAR(10))
WHERE	LEN([value]) > 0;

DECLARE	@i				int = 1
		,@tileID		int
		,@row			int
		,@column		int
		,@tiles			int
		,@tileRows		int
		,@tileColumns	int
		,@line			varchar(100)
		;

WHILE @i <= (SELECT MAX([id]) FROM @inputRaw)
BEGIN
	SELECT	@line = [value]
	FROM	@inputRaw
	WHERE	[id] = @i;

	IF SUBSTRING(@line, 1, 4) = 'tile'
	BEGIN
		SELECT	@tileID	= CAST(SUBSTRING(@line, 6, LEN(@line)-6) As int)
				,@row	= 1;

		INSERT INTO [#Tile] ([tileID])
		VALUES (@tileID);
	END
	ELSE
	BEGIN
		INSERT INTO [#TileContent] ([tileID], [row], [content])
		VALUES (@tileID, @row, @line);

		SELECT	@row += 1;
	END

	SELECT	@i += 1;
END

SELECT	@i = 1;

WHILE @i <= (SELECT COUNT(*) FROM [#Tile])
BEGIN
	SELECT	@tileID = [tileID]
	FROM	[#Tile]
	WHERE	[id] = @i;

	EXEC [dbo].[#ExtractEdgePattern] @tileID;

	SELECT	@i += 1;
END

UPDATE	[TE]
SET		[reverseID]	= [EPR].[patternID]
FROM	[#TileEdge] [TE]
JOIN	[#EdgePattern] [EP]		ON	[EP].[patternID]	= [TE].[patternID]
JOIN	[#EdgePattern] [EPR]	ON	[EPR].[content]		= REVERSE([EP].[content]);

SELECT	@tiles = COUNT(*)
FROM	[#Tile];

SELECT	@tileRows		= SQRT(@tiles)
		,@tileColumns	= SQRT(@tiles)

PRINT	@tiles
PRINT	@tileRows
PRINT	@tileColumns
PRINT	'---------------------'


EXEC [dbo].[#PlaceTile]
		@tileDepth		= 0
		,@tiles			= @tiles
		,@tileRows		= @tileRows
		,@tileColumns	= @tileColumns;

SELECT		*
FROM		[#TileEdge] [TE]
ORDER BY	[TE].[tileID], [TE].[reversed], [TE].[edge]

--Edges	0=N / 1=E / 2=S / 3=W

-- Test answer: 20899048083289
