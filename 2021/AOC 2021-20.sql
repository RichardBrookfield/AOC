USE [AOC];
SET NOCOUNT ON;
GO

-- Takes about a minute, no obvious ways to make it quicker do so.

DROP TABLE IF EXISTS [#Input];
DROP TABLE IF EXISTS [#Image];

GO

CREATE TABLE [#Input]
(
	[id]		int		IDENTITY(1,1)
	,[value]	varchar(MAX)
);

CREATE TABLE [#Image]
(
	[level]		int
	,[x]		int
	,[y]		int
	,[on]		bit
	
	,INDEX [idx_xy] UNIQUE CLUSTERED ([level], [x], [y])
);

GO

DECLARE	@inputT	varchar(MAX) = '
..#.#..#####.#.#.#.###.##.....###.##.#..###.####..#####..#....#..#..##..##
#..######.###...####..#..#####..##..#.#####...##.#.#..#.##..#.#......#.###
.######.###.####...#.##.##..#..#..#####.....#.#....###..#.##......#.....#.
.#..#..##..#...##.######.####.####.#.#...#.......#..#.#.#...####.##.#.....
.#..#...##.#.##..#...##.#.##..###.#......#.#.......#.#.#.####.###.##...#..
...####.#..#..#.##.#....##..#.####....##...##..#...#......#.#.......#.....
..##..####..#...#.#.#...##..#.#..###..#####........#..####......#..#

#..#.
#....
##..#
..#..
..###
';

DECLARE	@input	varchar(MAX) = '
##..#.#...##.####..#..###.#.#.#.#.####.#.##.....#####.##..#..#.#.##.......##.##.#.#...#....#.####..#.##.##....###..##.#####.##....##.#.#.#.#....####...##.#......#.#..##......##..#..###.#..####.###...##.#.##.#..##.##..#.#.#..###..##.####.#.#.#..#.##...#..##...##.#####..##.##..#...#..###.#.#...#..#..##...#.#..........#...#...#.#.#.#..#.###..##....####..#######.##.#.....#.#.###...##...###...#.##.##.##..#......#.###...#.#.#.#...##.#.#.##.#..###.#...##...##.......####.##..#.#....#.#####..#..#####.#.....#....#.#.

.##.#...##..##.#..........#####..#.##..######.##..#....#..#####.#.#####.#..#...#..#####..#.......##.
.#.#.#.#####..##.#.###..#.##.##.......#.####.#............#.#....####..#.#####.##.##.#.###..#..##...
.##.#.#...##....#.#..#...........##.#.#..#####...#..##.###..##.###..........#####..##..##.#.####....
##..####.####.###.......#....#.#####.##...#....###...##...###...#...##..####....####..#####..##..###
...###.##.....#......###.#.###..#..###...#.#..#.#######.##..#..#..#..##.##..#####.#####.###...#.###.
##.###.#....##..####.#..#.###.##.#.##..#...#...###.###.#..#..#.#.###.##.#..###.#.###....###.###.....
#.#.##..#.....#.....##....######...#........#.#.#.#.######..#...##.#.######...#.##########..#.###..#
.##.#...##.#......###..####.##.#...#..##.#.####...##..####..#####..##.###.#.###...#.#.######.#.#####
..#..##..#.#.#...####..###.#..#...#..#.#.#.#.###..####.#...#......#..#..####.#...#.#.#......#...#..#
#...###..#.#.###.#.##.##.#.#.#####....#....#.....#####...#..#..#.#####..##.....#..###.#..###.#..#...
..##.#.#..##.#.#...#...#.#.#..#.#.##....#####....#.##...#..#..#.#....###...##..#.#.##.##.#.......#.#
##.##.#######.###.#..#....#..##..#.###.....#.###..#.#..#....#.#..###.##.#.....#.#.#.##.#...#..##.#..
.....#.#.#.#.####.#..####.#....##.###.###...########.#.#....#..##.#.#####...##....##....#.......#.#.
##..#...#..#.#.####..#.#..####.#####.#####.###..#.#####.#..#...##.######.###.#..#.##.#.#..#..#.####.
#.##.##.#.####...#.#.#.#..####.#.#...###...#.#....##...####.#..#####.#.####.#..#.....###.#..#...#.#.
.#..#.##...####...##.####...###..####.##........#.#.##..#..#.##...#....##.#.#..#.#.###...##.......#.
..#..#..#.###.##...###....#.#..#..##..#...###.###...#..#.....#..#.####.#.#.#.##..###...#....##.#.###
###.##....##.#.##..####.#.###...###.###.#####..##.###.....#.#####....#.##..##.#####.##..###....#....
###..#...###..#....#..#.#...#....###.#.####.##..#.#..#.###..#..#.##.#.#.......#...#....#...###..#.##
#...#.#.#...#.####.##.#.#..#...##.....#..##....#..#.##..##.####.#.#.###..##..#.#.#.###.#.#..####..##
.###..###.##..###..#..#.##..#...#.##.#.......####.#..##.#...#.##..#..........##..####..##.###..###..
###.#.#...###..#...#####.####..#..#######.#.#.###.##.###.#.####.##.#####..###.#####.#...####.##..##.
.##..##..##.#...######.###...#.##.##....##.#...##.#####.#...##..#.#...#.#..#.##.#....##.####.#.##.#.
...####..#...#...####.#.#...#...###..#.##...####.#..######.##.....##..#...#...####.###.#..##.##..#..
#.#####.##.##..#..##.#.####..##.#.#...#..####.##..###.####.##.##...#.#...#.#.#####.####.#.###..#..#.
..#.....#..##..#...#####..##.###..##.#..##..##..####.#..#.####.###...#####.#.###.....#..#.####.#.##.
#####....###..##.#.######.#.##..##.#.#####.##########.#...##...###....###.#.....#.....###.#.#.#.##.#
##.....#.###.###.#.##.########....##.##.###...#######..##..#.#.#..#.##..####..#.###.#.###.#.#......#
..##..#...#.#.#.#.###.#..#####.#.#..#......####..#.###..###...##...##.##..#..#..#.##.#..###..##.#.#.
.#.#..#..###.##.#.#...#.#...##...#.###..#.#.##.#....#..####..#.#.##.#..#...##.#.....##...####.....#.
##.#..##...#..##.####.##....##..#####.###...#..######..#....#..#######..#..#.####.#...##.##..##..#..
..##.#.###....#..#.....#..#.#.#.#........#..##.#.#.......####.##...#.#.##.######..##..#....#.#......
.....#....#.#.##...#..######.###.###.##....##.#.##.###.....#..#.#....#####.#..##.#.....#..#.##....##
##.....#.#...####...##.##.#.##.#.##......#.#########.#.##..##...###.##.#..#....#..##.####..#######..
##...#.########.###.#....#...#..##.##.###....##...#####..##.####..##..#..#####.#..######.####...#.#.
##.####..##.#####..#..###...##.......#...#.###.#.#..#..#....#.#..##.....#.#....####.###...#.#..##.#.
#.#.#.#.###..#.#####.#...##...#.###.##..#.#####.....#...#.#.#..#...##....#...####.####.##.#.....####
..###.##.#......#######..#...##..###.##....#....#.#..###...#..###.#.#...#..##...####.###.###..#.#.##
.#..#.#.##..###########.#.#..#.###.######...###.##..#.###..##.#...#.#...###.#.##.##.#..#..#..#.#...#
.#..#.#..##....#....####.#..##....#.###.####..#.##.#.#..###.#.##.#........##.#...###.#.......##.#...
...###.#.#.##.##.##.....#.#.#..#..#.##.#######...##....#.#......##....##.#.####.####.###.#....##..#.
.#.##..#.##.##.####.....##...#..###.###.###..#..##.####..##...#.###.##..##..#####.#..###....###.##.#
#.###...#####.#..#.####...##.#..#...######.....#.#....##.#.#...##....#...........##.##.##.#...######
##..#..##.....##..#.#..##.##.#..#...####.######.......###..#..##.##..##..##..###..##.##.#.#.....#...
#......###..#####..#######.#.#..#.###..##.#..##.##.##.#..###.###..##.##.....#.#..####.#.##...##..###
.##...#..###..##..#.#####.#####.###...#.........#.##.##.###.#.#.#...###.#..###.##.##.#..#..#...###.#
#.###.###.###.#.###.#.##....##..##.......#....##.###.###.#.###..#..###.#.##.##..#.#...######.####..#
..#####.###.##.#..##.##.#..#.###..#.####....#...##.#.......#.#..##.#.......##.##.#######...######.##
#.##...###..#..##.....#.#.##.#..##...##.#####..#...##...#..#.####.#.##.##.#....##.###.#.##..##..#.#.
..#.###.#.##...#..##.#..####.###..#####.##.####.#.##..####.###..##..#...#.##...#.###....####...####.
.###.....###.#....######.#####..#..#..#.#.#..#..#.###.#........##.###...#...##..#..#...#.....#.###.#
..###.##.#.#####.#..########..##..##.#..###.#.##.#....#.###........#....#...#.#...##.#.##..#..##.##.
###.#.#.#...#..##....#.##....##.#######.#.##.#.##....#....###.#.#.....#.##..###..##..#..##..#.#..##.
.#.##..#.##..##.##.##..#.###.#..##.###.#.###.##......##.#...##.##..##...##.#...##.#..#..#.##..#.##..
####..####.###..#..#####...###.#....###.#...##........#.#...#..#.#.###..####.#.#.######...#..##.#.#.
#...#..#.##..#.#.#.#.#...##.#.##..#...#.###.###.#....##.#..##.#.###..##....#.###.#.##..#..##....#...
#.###.#.##.###.#..#...####.#....#..#.#####.#...#.###.##.##.###.###..#...#.#.####..###..........##.#.
##.##.#.###.#.##.####...###.#.###..###...####..#####.###...#.##...###.##..#.####.#.##...#....##.#.##
#....#..##.##.##......##...##.##..#####...#.##.###.##...##..##..###..#..#..#...###.##.#..#..#.#...##
###.####.....#.#....####..#.##.........#....##.....#....##.#..##.##..####..###.####.#...##....##.##.
#.......###.#..####.##..#..##...#....###...##.......##.....###.######.#..#..##..#....#.###.#..##.###
#.###.##..##..##.##...#.........####..####..#..##...##.#..#..#######.###...#......#.##.####.#..##...
#.####...##.#...#.#.###...##...#....#.##.##.####.#.#....###....#...#........##.##..#.#.####..#.#.#..
.#..###.#..#.....##..#..#.###..###.#.##...#.#.....#...#....#.##.#..#.#...#..#.#..###..#.#...###.....
.####....####....#.#.....#..#.#.##........#..#.####.##.##...#.#.####.#..#.##..##..#...#.#.##...#.#.#
#####.#...####.#.####.#...#..#...#.#.##.#..#...##..#.#...##.###.##.#.###.###.#...#..#.###.##.##...#.
#.#....#.###.##..##.##..##.#...#.###....###....###..#.####.###..#.#.##...#..####....#.####...###.#..
.#...#.###.#.####..#.#####...##...#..##........#....#..#.#.##..##.##.#######.#.#.#.##.#.#.#.##..#...
#....#....#.#.##.##.##..###..###.##..#.##.....###.###......#.#....#..#.##......#.###.#..#.#.#.#..###
#####.#####.##...#.#..#..##.####.#......######..####..##.##.##.#.......#...####..#..###.#..##.#.#.#.
#.##...##..##......###...#.#.##...#.#...#..##.###.#..#.##...#.#.#.##.###.##.#####....#...#.....##..#
..##....##..#..##..##...#..#.##.####.##........###..##.##.#.#.##..#..###...#..#...##.#.##.########.#
#...#.#####.###.#....#....#######.###..#..#.#..##..#.###.#.####.##.#..###..#....###.###....###.#..##
.......###.#.#.#..#.#..###...#.##..#..#...#..#....#..#...#.#####.#...##.#.###.###.#..#.##.#..##.....
....#.##...#.##.#.###..#####..#.######.###...###..##.#.#.##.###.##.####..#..#.....#.......#.######.#
##..####......##...##.#..#..#..#..##.#.#..##..####.#.######.#...##..#..#.##.##..###..#..#.#..#..#...
.##.#..#..##.#.##..#..#.#.#...##.##...##.#.########..##..#...#####.....#.#..###.#.##.##.###..#..#.##
..##...#.#..#.#.##.###..#....#..###...#..##....##.#..######..###.#.#####..#.###.##.###..#####...####
#.#..###.##.#...#..###..#.##.##...####.####.#.....##....###..#..#...####.####.###...#..#.#.#.#.##..#
###..##...#.#..##..#...##..###.#.....#...##.###.#..###...###.####..###.#..#.#...##.....#............
.#####..##...##....######...#..###.#.#......#...######.#..#...###.#...#..####.#......##..#..#.#...#.
.#..####.#.#..###..#.#.##.####..#.#....#.####..##...#..#.#.#..###.........##.#.#####...###...#.#..#.
.#.#....#..####..##..#########.#..#.##..###..#..#...###....##.....####...#..#.##....#######.####.##.
##.#.####..#...#..#.##.#..#....##.####..####..###.#.#...#######.#.###..###.###..#.###.##...##.##..#.
.#####.....##.#....##...##...#.#..####.##..#....##.###.#####.##.#.#.#...#...#.#.#.......##..##.##.#.
.##..#.#.###.#.#.#....##.#...#....#...#...#..#######....##.#.#.#####.#.###..#..#...#......#..#.##..#
...##.....#..#.####.###...#####.#.#....##.#.#.#.#...####.####.#..##.#.##.##.###..##...##.....#...###
####.###..###.####..###.##..#.#####.#...##.#..#.#.##.####.#..####..#..##....####.#....#...#.####.#.#
##....##.#.#.##.###..#####.##..##..#..##..##..#.#..###.##.#####...#..#.##.#.####.####..#...##..#..##
#.#..###..##..#..#..####..#..#.#..#.##...###.#.#.#.#...####.#.#...####.##..#.#.#..#.##..##..##.#....
##.#.####....##..##..####.#######..##....######.##.#....#..#...#.#..#.##.#...#.#.#.#.#..###....#.#.#
.##.###..#.###..##...####.###.#.##.###.#...#..#......######.##.##.##.####.##.##....#.#......####.#.#
#..###.####.#...#.###.###.#..##.###..#.#.#####..#.##.##.#.##.##..###.####...####..#..###...#.##.####
#...............#.##.###...#..#..#.##.##.#.##.#.#...#.#....#..#.######..#..#..##....#.##..#..#..#.##
###.###...#...#..#....##.......#.#..#...##...#....#..######..#.....##.####..#....#...##...######..##
..##..#..##.#.##..###.#...............####...##..##......#...#.....#..#....#.#...#.....##..#####..##
#.....##.#.##.###......###.#.##..###....###..#...#..###.#..#..##...#..#.##...#.#...#..#.....##...#.#
..##....#..#.#.#.####..#.#.#....#.#.#.#.##.#..#.#..#..#.#.##.####......##..#...##..#.#.##..#.....#..
.#..##....###.###..##....#####.#....####....#.#.##..#...#.###.##..#.....##........###.###.####..#.#.
.###.##..#..#...#.#.#######.##.#.#.#.#.###.#.#.#.#......#####.###.#.#.#......#.#..#.#.##..#.##.#.#.#
';

DECLARE	@i			int				= 1
		,@x			int
		,@y			int				= 1
		,@level		int				= 0
		,@line		varchar(1000)
		,@key		varchar(520)	= '';

INSERT INTO	[#Input] ([value])
SELECT	[value]
FROM	STRING_SPLIT(REPLACE(@Input, CHAR(13), ''), CHAR(10))
WHERE	[value] <> '';

WHILE @i <= (SELECT MAX([id]) FROM [#Input])
BEGIN
	SELECT	@line = [value]
	FROM	[#Input]
	WHERE	[id] = @i;

	IF LEN(@key) < 512
	BEGIN
		SELECT	@key += @line;
	END
	ELSE
	BEGIN
		SELECT	@x = 1;

		WHILE @x <= LEN(@line)
		BEGIN
			INSERT INTO
					[#Image] ([level], [x], [y], [on])
			SELECT	@level, @x, @y, IIF(SUBSTRING(@line, @x, 1) = '#', 1, 0);

			SELECT	@x += 1;
		END

		SELECT	@y += 1;
	END

	SELECT	@i += 1;
END

DECLARE	@minX		int
		,@maxX		int
		,@minY		int
		,@maxY		int
		,@updated	bit
		,@default	int;

WHILE @level < 50
BEGIN
	SELECT	@minX	= MIN([x])
			,@maxX	= MAX([x])
			,@minY	= MIN([y])
			,@maxY	= MAX([y])
	FROM	[#Image]
	WHERE	[level]	= @level;

	-- The huge problem with the actual problem compared to the test is that the "infinite
	-- border" flashes between on and off, because the 0-value in the key is on.
	SELECT	@default = CASE WHEN SUBSTRING(@key, 1, 1) = '#'
						THEN @level % 2
						ELSE 0
						END;

	-- We now need to pad out the board as much as is needed (if at all).
	SELECT	@updated = 0;

	IF (SELECT MIN([x]) FROM [#Image] WHERE [level] = @level AND [on] <> @default) < @minX + 2
	BEGIN
		SELECT	@minX		-= 2
				,@updated	= 1;
	END

	IF (SELECT MAX([x]) FROM [#Image] WHERE [level] = @level AND [on] <> @default) > @maxX - 2
	BEGIN
		SELECT	@maxX		+= 2
				,@updated	= 1;
	END

	IF (SELECT MIN([y]) FROM [#Image] WHERE [level] = @level AND [on] <> @default) < @minY + 2
	BEGIN
		SELECT	@minY		-= 2
				,@updated	= 1;
	END

	IF (SELECT MAX([y]) FROM [#Image] WHERE [level] = @level AND [on] <> @default) > @maxY - 2
	BEGIN
		SELECT	@maxY		+= 2
				,@updated	= 1;
	END

	IF @updated = 1
	BEGIN
		WITH [AllX] AS
		(
			SELECT	[x]	= [number] + @minX
			FROM	[master].[dbo].[spt_values]
			WHERE	[type]		= 'P'
			AND		[number]	<= @maxX - @minX
		)
		, [AllY] AS
		(
			SELECT	[y]	= [number] + @minY
			FROM	[master].[dbo].[spt_values]
			WHERE	[type]		= 'P'
			AND		[number]	<= @maxY - @minY
		)
		INSERT INTO [#Image] ([level], [x], [y], [on])
		SELECT	@level, [AllX].[x], [AllY].[y], @default
		FROM	[AllX]
		CROSS JOIN	[AllY]
		WHERE	NOT EXISTS (
						SELECT	1
						FROM	[#Image] [I]
						WHERE	[I].[x]		= [AllX].[x]
						AND		[I].[y]		= [AllY].[y]
						AND		[I].[level]	= @level
						);
	END

	SELECT	@minX	= MIN([x])
			,@maxX	= MAX([x])
			,@minY	= MIN([y])
			,@maxY	= MAX([y])
	FROM	[#Image]
	WHERE	[level]	= @level;

	WITH [AllX] AS
	(
		SELECT	[x]	= [number] + @minX
		FROM	[master].[dbo].[spt_values]
		WHERE	[type]		= 'P'
		AND		[number]	<= @maxX - @minX
	)
	, [AllY] AS
	(
		SELECT	[y]	= [number] + @minY
		FROM	[master].[dbo].[spt_values]
		WHERE	[type]		= 'P'
		AND		[number]	<= @maxY - @minY
	)
	INSERT INTO
			[#Image]
			([level], [x], [y], [on])
	SELECT	@level+1, [AllX].[x], [AllY].[y], [Key].[Value]
	FROM	[AllX]
	CROSS JOIN		[AllY]
	INNER JOIN		[#Image] [I0]	ON	[I0].[x]		= [AllX].[x]
									AND	[I0].[y]		= [AllY].[y]
									AND	[I0].[level]	= @level
	LEFT OUTER JOIN	[#Image] [I1]	ON	[I1].[x]		= [I0].[x] - 1
									AND	[I1].[y]		= [I0].[y] - 1
									AND	[I1].[level]	= @level
	LEFT OUTER JOIN	[#Image] [I2]	ON	[I2].[x]		= [I0].[x]
									AND	[I2].[y]		= [I0].[y] - 1
									AND	[I2].[level]	= @level
	LEFT OUTER JOIN	[#Image] [I3]	ON	[I3].[x]		= [I0].[x] + 1
									AND	[I3].[y]		= [I0].[y] - 1
									AND	[I3].[level]	= @level
	LEFT OUTER JOIN	[#Image] [I4]	ON	[I4].[x]		= [I0].[x] - 1
									AND	[I4].[y]		= [I0].[y]
									AND	[I4].[level]	= @level
	LEFT OUTER JOIN	[#Image] [I5]	ON	[I5].[x]		= [I0].[x] + 1
									AND	[I5].[y]		= [I0].[y]
									AND	[I5].[level]	= @level
	LEFT OUTER JOIN	[#Image] [I6]	ON	[I6].[x]		= [I0].[x] - 1
									AND	[I6].[y]		= [I0].[y] + 1
									AND	[I6].[level]	= @level
	LEFT OUTER JOIN	[#Image] [I7]	ON	[I7].[x]		= [I0].[x]
									AND	[I7].[y]		= [I0].[y] + 1
									AND	[I7].[level]	= @level
	LEFT OUTER JOIN	[#Image] [I8]	ON	[I8].[x]		= [I0].[x] + 1
									AND	[I8].[y]		= [I0].[y] + 1
									AND	[I8].[level]	= @level
	CROSS APPLY	(	SELECT	[Value]	= IIF(ISNULL([I1].[on], @default) = 1, 256, 0)
									+ IIF(ISNULL([I2].[on], @default) = 1, 128, 0)
									+ IIF(ISNULL([I3].[on], @default) = 1,  64, 0)
									+ IIF(ISNULL([I4].[on], @default) = 1,  32, 0)
									+ IIF(ISNULL([I0].[on], @default) = 1,  16, 0)
									+ IIF(ISNULL([I5].[on], @default) = 1,   8, 0)
									+ IIF(ISNULL([I6].[on], @default) = 1,   4, 0)
									+ IIF(ISNULL([I7].[on], @default) = 1,   2, 0)
									+ IIF(ISNULL([I8].[on], @default) = 1,   1, 0)
				) [Bitmask]
	CROSS APPLY	(	SELECT	[Value]	= IIF(SUBSTRING(@key, [Bitmask].[Value] + 1, 1) = '#', 1, 0)
				) [Key];

	SELECT	@level += 1;

	IF @level = 2
	BEGIN
		SELECT	[Part 1] = COUNT(*)
		FROM	[#Image]
		WHERE	[level]	= @level
		AND		[on]	= 1;
	END
END

SELECT	[Part 2] = COUNT(*)
FROM	[#Image]
WHERE	[level]	= @level
AND		[on]	= 1;
